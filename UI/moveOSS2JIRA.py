import wx
import os
import sys
import WebsIteHandle.Config_Setting as UserConfig
import base.FileOperation as FileOperation
import WebsIteHandle.WebsiteHandle as WebsiteHandle


class movefileUIBase(wx.Panel):
    _m_OSSVUL_pathexcel = None
    _m_EXCEL2JIRA_pathexcel = None
    _m_logText =None
    _m_assigne = None
    _m_Teamdevelopment = None
    _m_Functionality = None
    _m_Teamtest = None
    _m_Bugfoundby = None
    _m_Reproducibility = None

    btn_open_OSSVULexcel = None
    btn_open_EXCEL2JIRAexcel = None

    btn_run = None

    def __init__(self, parent):
        wx.Panel.__init__(self, parent)
        self._initUIFGS()
        self._2ndInit()

    def _2ndInit(self):
        pass

    def _initUIFGS(self):
        hbox = wx.BoxSizer(wx.HORIZONTAL)
        fgs = wx.FlexGridSizer(11, 2, 10, 10)

        ossvul_path_excel_label = wx.StaticText(self, label='OSS VUL Excel Path: ')
        self._m_OSSvul_pathexcel = wx.TextCtrl(self, style=wx.TE_READONLY)
        excel2jira_path_excel_label = wx.StaticText(self, label=' Excel 2 JIRA Path: ')
        self._m_EXCEL2JIRA_pathexcel = wx.TextCtrl(self, style=wx.TE_READONLY)
        excel2jira_assigne_label = wx.StaticText(self, label='Assigne to(填简写): ')
        self._m_assigne = wx.TextCtrl(self)
        excel2jira_Teamdevelopment_label = wx.StaticText(self, label='Teamdevelopment(填编号): ')
        self._m_Teamdevelopment = wx.TextCtrl(self)
        excel2jira_Functionality_label = wx.StaticText(self, label='Functionality: ')
        self._m_Functionality = wx.TextCtrl(self)
        excel2jira_Teamtest_label = wx.StaticText(self, label='Teamtest(填编号): ')
        self._m_Teamtest = wx.TextCtrl(self)
        excel2jira_Bugfoundby_label = wx.StaticText(self, label='Bugfoundby: ')
        self._m_Bugfoundby = wx.TextCtrl(self)
        excel2jira_Reproducibility_label = wx.StaticText(self, label='Reproducibility: ')
        self._m_Reproducibility = wx.TextCtrl(self)

        self._m_Teamdevelopment.SetValue('114')
        self._m_Functionality.SetValue('General')
        self._m_Teamtest.SetValue('114')
        self._m_Bugfoundby.SetValue('other')
        self._m_Reproducibility.SetValue('always')

        log_label = wx.StaticText(self, label='Log: ')
        # self._m_logText = wx.TextCtrl(self, style=wx.TE_MULTILINE | wx.HSCROLL | wx.TE_READONLY)
        self._m_logText = wx.TextCtrl(self, style=wx.TE_MULTILINE | wx.HSCROLL)

        self.btn_open_OSSVULexcel = wx.Button(self, label="Open OSSVULExcel")
        self.btn_open_OSSVULexcel.Bind(wx.EVT_BUTTON, self._openOSSVULExcel)
        self.btn_open_EXCEL2JIRAexcel = wx.Button(self, label="Open Excel2JIRA Excel")
        self.btn_open_EXCEL2JIRAexcel.Bind(wx.EVT_BUTTON, self._openExcel2JIRAExcel)

        self.btn_run = wx.Button(self, label="Run")
        self.btn_run.Bind(wx.EVT_BUTTON, self._Run)

        # title = wx.StaticText(self, label = "Title")
        # author = wx.StaticText(self, label = "Name of the Author")
        # review = wx.StaticText(self, label = "Review")
        # tc1 = wx.TextCtrl(self)
        # tc2 = wx.TextCtrl(self)
        # tc3 = wx.TextCtrl(self, style = wx.TE_MULTILINE)
        fgs.AddMany([(ossvul_path_excel_label), (self._m_OSSvul_pathexcel,1, wx.EXPAND),
                     (excel2jira_path_excel_label), (self._m_EXCEL2JIRA_pathexcel, 1, wx.EXPAND),
                     (excel2jira_assigne_label), (self._m_assigne, 1, wx.EXPAND),
                     (excel2jira_Teamdevelopment_label), (self._m_Teamdevelopment, 1, wx.EXPAND),
                     (excel2jira_Functionality_label), (self._m_Functionality, 1, wx.EXPAND),
                     (excel2jira_Teamtest_label), (self._m_Teamtest, 1, wx.EXPAND),
                     (excel2jira_Bugfoundby_label), (self._m_Bugfoundby, 1, wx.EXPAND),
                     (excel2jira_Reproducibility_label), (self._m_Reproducibility, 1, wx.EXPAND),
                     (log_label), (self._m_logText, 1, wx.EXPAND),
                     (self.btn_open_OSSVULexcel), (self.btn_open_EXCEL2JIRAexcel), (self.btn_run)])
        fgs.AddGrowableRow(8, 1) #指定log行适配屏幕大小
        fgs.AddGrowableCol(1, 1)
        hbox.Add(fgs, proportion=2, flag=wx.ALL | wx.EXPAND, border=10)
        self.SetSizer(hbox)

    def _openExcel2JIRAExcel(self, event):
        wildcard = 'All files(*.*)|*.*'
        dialog = wx.FileDialog(None, 'select', os.getcwd(), '', wildcard, wx.FD_OPEN)
        if dialog.ShowModal() == wx.ID_OK:
            self._m_EXCEL2JIRA_pathexcel.SetValue(dialog.GetPath())
            UserConfig.EXCEL2JIRA_PATH = dialog.GetPath().replace('\\', '/')
            self._addLogText(UserConfig.EXCEL2JIRA_PATH)
            dialog.Destroy

    def _openOSSVULExcel(self, event):
        wildcard = 'All files(*.*)|*.*'
        dialog = wx.FileDialog(None, 'select', os.getcwd(), '', wildcard, wx.FD_OPEN)
        if dialog.ShowModal() == wx.ID_OK:
            self._m_OSSvul_pathexcel.SetValue(dialog.GetPath())
            UserConfig.OSSVULFILE_PATH = dialog.GetPath().replace('\\', '/')
            self._addLogText(UserConfig.OSSVULFILE_PATH)
            dialog.Destroy


    def _Run(self, event):
        if '_' not in self._m_assigne.GetValue():
            self._addLogText("请输入指定用户")
            return None
        else:
            UserConfig.JIRA_ASSIGNE_VALUE = self._m_assigne.GetValue()
        if self._m_Teamdevelopment.GetValue() is None:
            self._addLogText("请输入Teamdevelopment")
            return None
        else:
            UserConfig.JIRA_Teamdevelopment_VALUE = self._m_Teamdevelopment.GetValue()
        if self._m_Functionality.GetValue() is None:
            self._addLogText("请输入Functionality")
            return None
        else:
            UserConfig.JIRA_Functionality_VALUE = self._m_Functionality.GetValue()
        if self._m_Teamtest.GetValue() is None:
            self._addLogText("请输入Teamtest")
            return None
        else:
            UserConfig.JIRA_Teamtest_VALUE = self._m_Teamtest.GetValue()
        if self._m_Bugfoundby.GetValue() is None:
            self._addLogText("请输入Bugfoundby")
            return None
        else:
            UserConfig.JIRA_Bugfoundby_VALUE = self._m_Bugfoundby.GetValue()
        if self._m_Reproducibility.GetValue() is None:
            self._addLogText("请输入Reproducibility")
            return None
        else:
            UserConfig.JIRA_Reproducibility_VALUE = self._m_Reproducibility.GetValue()
        if ".xlsx" not in UserConfig.OSSVULFILE_PATH:
            self._addLogText("错误的excel文件路径")
            return None
        vulinfo = FileOperation.GetVulinfo(UserConfig.OSSVULFILE_PATH)
        # self._addLogText(str(len(vulinfo)))
        # self._addLogText(str(vulinfo[0][0]))
        # self._addLogText(str(vulinfo[0][1]))
        if ".xlsx" not in UserConfig.EXCEL2JIRA_PATH:
            self._addLogText("错误的excel文件路径")
            return None
        FileOperation.writeVulinfo2JIRA(UserConfig.EXCEL2JIRA_PATH, vulinfo)
        self._addLogText("完成转换")

    def _addLogText(self, logContent):
        self._m_logText.SetValue(self._m_logText.GetValue() + '\n' + logContent)

    def _clearLogText(self):
        self._m_logText.SetValue('')

    # def _operateExcel(self, _excelPath):
    #     self._m_DoExcel = CDoExcel(_excelPath)

